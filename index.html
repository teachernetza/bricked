<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Bricked - (not) DoomScrolling">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BRICKED | OS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        /**
         * üö® ZONA DE CONFIGURACI√ìN DEL USUARIO üö®
         * Pega aqu√≠ el link que obtuviste en: Archivo > Compartir > Publicar en la web > CSV
         */
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRH7tvjL9usAdbPX9T4hVaPjbk0eykei7sghqShiMzUMvUtpH80BEniasmAWBlgtjH4UjVy5dJBT-So/pub?output=csv"; 
        
        // Configuraci√≥n de Tailwind para el Design System "Bricked"
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // Paleta Industrial
                        bg: '#050505',          // Negro Profundo
                        surface: '#0F0F0F',     // Gris Asfalto
                        surfaceLight: '#1A1A1A',// Gris Concreto
                        border: '#262626',      // Borde Sutil
                        
                        // Acentos
                        brick: '#E63946',       // Rojo Ladrillo (Primary)
                        brickDark: '#9D0208',   // Rojo Sangre (Hover)
                        alert: '#F4A261',       // Naranja Industrial
                        
                        // Texto
                        txtMain: '#EDEDED',
                        txtMuted: '#8D8D8D',
                    },
                    height: {
                        'screen-dvh': '100dvh', // Altura real en m√≥viles
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Reset y Base */
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body { 
            background-color: #050505; 
            color: #EDEDED; 
            overflow: hidden; /* El body no scrollea, solo el contenedor */
            overscroll-behavior-y: none; /* Evita el rebote en iOS */
            -webkit-font-smoothing: antialiased;
        }

        /* Ocultar Scrollbars pero mantener funcionalidad */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- MOTOR DE SCROLL (SNAP) --- */
        #feed-engine {
            height: 100dvh;
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            position: relative;
            z-index: 10;
        }

        .brick-card {
            scroll-snap-align: start;
            scroll-snap-stop: always;
            height: 100dvh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #050505;
        }

        /* --- TEXTURAS & EFECTOS --- */
        
        /* Efecto de Ruido (Noise) para textura de "Concreto" */
        .bg-noise {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Sombra de Texto Industrial */
        .text-glow {
            text-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        
        /* Glassmorphism Industrial */
        .glass-panel {
            background: rgba(15, 15, 15, 0.90);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* L√≠neas de conexi√≥n decorativas */
        .connection-line {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            z-index: 1;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    </style>
</head>
<body class="antialiased selection:bg-brick selection:text-white">

    <div class="bg-noise"></div>

    <div id="app-layer-onboarding" class="fixed inset-0 z-50 bg-bg flex flex-col transition-transform duration-700 ease-in-out">
        
        <div class="pt-[var(--safe-top)] px-6 mt-6 mb-4 z-10">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-3 h-3 bg-brick"></div>
                <span class="text-[10px] font-mono tracking-[0.2em] text-brick uppercase">System Boot</span>
            </div>
            <h1 class="text-5xl font-black text-white tracking-tighter mb-2">BRICKED<span class="text-brick">.</span></h1>
            <p class="text-txtMuted font-mono text-xs max-w-[250px]">Construye tu conocimiento, un bloque a la vez.</p>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-32 no-scrollbar">
            <div class="flex justify-between items-end mb-6 border-b border-border pb-2">
                <span class="text-xs font-bold text-white uppercase tracking-widest">Protocolo de Inicio</span>
                <span id="counter-interests" class="text-xs font-mono text-brick">0/3</span>
            </div>
            
            <div id="grid-interests" class="grid grid-cols-2 gap-3"></div>
        </div>

        <div class="absolute bottom-0 left-0 w-full p-6 pb-[calc(var(--safe-bottom)+1rem)] bg-gradient-to-t from-bg via-bg to-transparent z-20">
            <button id="btn-start" onclick="App.completeOnboarding()" disabled 
                class="group w-full h-14 bg-white text-black font-bold text-sm font-mono uppercase tracking-widest disabled:opacity-20 disabled:cursor-not-allowed transition-all active:scale-[0.98] flex items-center justify-center gap-3">
                <span>Inicializar Feed</span>
                <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
            </button>
        </div>
    </div>

    <nav class="fixed top-0 left-0 w-full z-40 px-5 pt-[var(--safe-top)] mt-4 flex justify-between items-start pointer-events-none mix-blend-difference">
        <div class="pointer-events-auto border border-white/20 bg-black/20 backdrop-blur px-3 py-1 flex items-center gap-2">
            <div class="w-1.5 h-1.5 rounded-full bg-brick animate-pulse"></div>
            <span class="text-[10px] font-mono font-bold text-white tracking-widest">LIVE v1.0</span>
        </div>

        <button onclick="Sidebar.toggle()" class="pointer-events-auto p-3 border border-white/20 bg-black/20 backdrop-blur text-white hover:bg-white/10 active:scale-90 transition-all group">
            <i data-lucide="menu" class="w-6 h-6 group-hover:rotate-90 transition-transform duration-300"></i>
        </button>
    </nav>

    <main id="feed-engine">
        <div id="loader-initial" class="h-screen w-full flex flex-col items-center justify-center bg-bg relative">
            <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20"></div>
            <div class="flex flex-col items-center gap-6 z-10">
                <div class="w-16 h-16 border-4 border-brick border-t-transparent animate-spin rounded-none"></div>
                <div class="flex flex-col items-center gap-1">
                    <p class="text-xs font-mono text-brick uppercase tracking-widest animate-pulse">Cargando M√≥dulos</p>
                    <p class="text-[10px] text-txtMuted font-mono">Sincronizando Sheets...</p>
                </div>
            </div>
        </div>
    </main>

    <div id="loader-infinite" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-30 opacity-0 transition-opacity pointer-events-none pb-[var(--safe-bottom)]">
        <div class="flex gap-1">
            <div class="w-1 h-4 bg-brick animate-[pulse_1s_ease-in-out_infinite]"></div>
            <div class="w-1 h-4 bg-brick animate-[pulse_1s_ease-in-out_0.2s_infinite]"></div>
            <div class="w-1 h-4 bg-brick animate-[pulse_1s_ease-in-out_0.4s_infinite]"></div>
        </div>
    </div>

    <div id="toast-zone" class="fixed top-24 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2 w-max max-w-[90vw] pointer-events-none"></div>

    <div id="sidebar-backdrop" onclick="Sidebar.toggle()" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"></div>
    
    <aside id="sidebar-panel" class="fixed inset-y-0 right-0 z-50 w-80 glass-panel transform translate-x-full transition-transform duration-300 flex flex-col bg-[#0a0a0a]">
        <div class="pt-[var(--safe-top)] mt-6 px-6 pb-6 border-b border-border flex justify-between items-center">
            <h2 class="font-bold text-xl text-white tracking-tight">Estructura</h2>
            <button onclick="Sidebar.toggle()" class="text-txtMuted hover:text-white transition"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 no-scrollbar">
            
            <div class="mb-8">
                <h3 class="text-[10px] font-mono text-txtMuted uppercase mb-4 tracking-widest border-l-2 border-brick pl-2">M√©tricas</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-surfaceLight p-4 border border-border">
                        <span id="stat-read" class="block text-3xl font-black text-white mb-1">0</span>
                        <span class="text-[9px] font-bold text-txtMuted uppercase tracking-wider">Bloques Le√≠dos</span>
                    </div>
                    <div class="bg-surfaceLight p-4 border border-border">
                        <span id="stat-saved" class="block text-3xl font-black text-brick mb-1">0</span>
                        <span class="text-[9px] font-bold text-txtMuted uppercase tracking-wider">Favoritos</span>
                    </div>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-[10px] font-mono text-txtMuted uppercase mb-4 tracking-widest border-l-2 border-white pl-2">Filtros Activos</h3>
                <div id="list-active-filters" class="flex flex-wrap gap-2">
                    </div>
            </div>

            <div class="mt-auto space-y-3">
                <button onclick="App.refreshData()" class="w-full py-3 bg-white/5 border border-white/10 text-white text-xs font-mono uppercase hover:bg-white/10 transition flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Recargar Sheets
                </button>
                
                <button onclick="App.hardReset()" class="w-full py-3 border border-brick/30 text-brick text-xs font-mono uppercase hover:bg-brick/10 transition flex items-center justify-center gap-2">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Formatear Sistema
                </button>
            </div>
            
            <div class="mt-8 text-center">
                <p class="text-[9px] font-mono text-txtMuted">BRICKED OS v1.0.4<br>System Operational</p>
            </div>
        </div>
    </aside>

    <script>
        
        /**
         * M√ìDULO 1: UTILIDADES & HELPERS
         * Funciones auxiliares para el funcionamiento general.
         */
        const Utils = {
            // Genera una espera as√≠ncrona
            wait: (ms) => new Promise(r => setTimeout(r, ms)),
            
            // Mezcla un array (Algoritmo Fisher-Yates)
            shuffle: (array) => {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            },

            // Vibraci√≥n h√°ptica segura
            vibrate: (pattern = 10) => {
                if (navigator.vibrate) navigator.vibrate(pattern);
            },

            // Sistema de Notificaciones Toast
            toast: (msg, type = 'normal') => {
                const el = document.createElement('div');
                const color = type === 'error' ? 'text-brick border-brick' : 'text-white border-white/20';
                el.className = `bg-black/80 backdrop-blur px-4 py-3 border ${color} text-xs font-mono font-bold uppercase tracking-wide shadow-2xl animate-fade-in flex items-center gap-3`;
                
                el.innerHTML = `
                    <div class="w-2 h-2 bg-${type === 'error' ? 'brick' : 'white'} animate-pulse"></div>
                    ${msg}
                `;
                
                const container = document.getElementById('toast-zone');
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 500);
                }, 3000);
            }
        };

        /**
         * M√ìDULO 2: DATOS DE RESPALDO (MOCK DATA)
         * Se usa si no hay link de Sheets o si falla la carga.
         * Cumple con el requisito de tener datos de ejemplo robustos.
         */
        const MOCK_DB = [
            { Categoria: "Tecnolog√≠a", Titulo: "La Paradoja de Moravec", Resumen: "Es f√°cil conseguir que las computadoras muestren capacidades similares a las de un adulto en test de inteligencia, pero dif√≠cil que tengan las habilidades perceptivas y motrices de un ni√±o de un a√±o.", Fuente: "AI Magazine", Link: "#", ImagenKeyword: "Robot Hand" },
            { Categoria: "F√≠sica", Titulo: "Entrelazamiento Cu√°ntico", Resumen: "Un fen√≥meno donde dos part√≠culas quedan ligadas y comparten el mismo estado f√≠sico, sin importar la distancia que las separe, incluso a a√±os luz. Einstein lo llam√≥ 'acci√≥n fantasmal a distancia'.", Fuente: "Nature Physics", Link: "#", ImagenKeyword: "Quantum Particles" },
            { Categoria: "Psicolog√≠a", Titulo: "Efecto Zeigarnik", Resumen: "El cerebro tiende a recordar mejor las tareas incompletas o interrumpidas que las que se han completado. Por eso los 'cliffhangers' en las series funcionan tan bien.", Fuente: "Psychology Today", Link: "#", ImagenKeyword: "Brain Synapse" },
            { Categoria: "Historia", Titulo: "El Manuscrito Voynich", Resumen: "Un libro ilustrado de contenidos desconocidos, escrito hace unos 500 a√±os por un autor an√≥nimo en un alfabeto no identificado y un idioma incomprensible. Nunca ha sido descifrado.", Fuente: "Yale Library", Link: "#", ImagenKeyword: "Old Book Mystery" },
            { Categoria: "Biolog√≠a", Titulo: "Inmortalidad Biol√≥gica", Resumen: "La medusa Turritopsis dohrnii es biol√≥gicamente inmortal. Puede revertir su ciclo de vida desde la etapa adulta a la inmadurez de p√≥lipo repetidamente.", Fuente: "National Geo", Link: "#", ImagenKeyword: "Jellyfish Deep Sea" },
            { Categoria: "Econom√≠a", Titulo: "Cisne Negro", Resumen: "Teor√≠a de Nassim Taleb que describe sucesos sorpresivos, de gran impacto socioecon√≥mico y que, una vez pasados, se racionalizan por retrospecci√≥n haciendo que parezcan predecibles.", Fuente: "Investopedia", Link: "#", ImagenKeyword: "Black Swan Abstract" },
            { Categoria: "Filosof√≠a", Titulo: "El Basilisco de Roko", Resumen: "Un experimento mental que plantea que una futura superinteligencia artificial podr√≠a castigar retroactivamente a todos los que no ayudaron a crearla.", Fuente: "LessWrong", Link: "#", ImagenKeyword: "Evil AI Red" },
            { Categoria: "Arte", Titulo: "Vantablack", Resumen: "Una sustancia hecha de nanotubos de carbono que es una de las sustancias m√°s oscuras conocidas, absorbiendo hasta el 99.965% de la radiaci√≥n de luz visible.", Fuente: "Surrealism Art", Link: "#", ImagenKeyword: "Black Hole Texture" },
            { Categoria: "Astronom√≠a", Titulo: "La Gran Muralla Sloan", Resumen: "Una de las estructuras m√°s grandes conocidas en el universo. Es una pared gigante de galaxias que mide 1.37 mil millones de a√±os luz de largo.", Fuente: "NASA Hubblesite", Link: "#", ImagenKeyword: "Galaxy Cluster" },
            { Categoria: "Derecho", Titulo: "Nulla Poena Sine Lege", Resumen: "Principio fundamental: 'No hay pena sin ley'. Nadie puede ser castigado por algo que no estaba prohibido por la ley en el momento en que se cometi√≥.", Fuente: "Legal Dictionary", Link: "#", ImagenKeyword: "Gavel Courtroom" }
        ];

        /**
         * M√ìDULO 3: GESTI√ìN DE ESTADO (LOCALSTORAGE)
         * Persistencia de datos del usuario.
         */
        const Store = {
            key: 'bricked_os_v1',
            data: {
                onboarding: false,
                interests: [],
                viewed: [], // IDs (T√≠tulos) vistos para no repetir
                likes: []   // IDs (T√≠tulos) guardados
            },

            init() {
                const saved = localStorage.getItem(this.key);
                if (saved) {
                    this.data = JSON.parse(saved);
                }
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify(this.data));
                Sidebar.updateUI();
            },

            markViewed(id) {
                if (!this.data.viewed.includes(id)) {
                    this.data.viewed.push(id);
                    // L√≠mite de historia para no saturar memoria (300 items)
                    if (this.data.viewed.length > 300) this.data.viewed.shift();
                    this.save();
                }
            },

            toggleLike(id) {
                if (this.data.likes.includes(id)) {
                    this.data.likes = this.data.likes.filter(item => item !== id);
                    this.save();
                    return false;
                } else {
                    this.data.likes.push(id);
                    this.save();
                    return true;
                }
            },

            reset() {
                localStorage.removeItem(this.key);
                location.reload();
            }
        };

        /**
         * M√ìDULO 4: MOTOR DE CONTENIDO
         * L√≥gica de filtrado y fallback.
         */
        const ContentEngine = {
            db: [], // Base de datos cruda
            
            async load() {
                return new Promise(resolve => {
                    // Si no hay URL, usar Mock Data
                    if (!GOOGLE_SHEET_CSV_URL || GOOGLE_SHEET_CSV_URL.length < 5) {
                        console.warn("Bricked: Usando Base de Datos Local (Modo Demo)");
                        this.db = MOCK_DB;
                        resolve();
                        return;
                    }

                    Papa.parse(GOOGLE_SHEET_CSV_URL, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            if (results.data && results.data.length > 0) {
                                // Limpieza b√°sica de datos
                                this.db = results.data.filter(row => row.Titulo && row.Categoria);
                                console.log(`Bricked: ${this.db.length} bloques cargados desde Sheets.`);
                            } else {
                                this.db = MOCK_DB;
                            }
                            resolve();
                        },
                        error: (err) => {
                            console.error("Error CSV:", err);
                            this.db = MOCK_DB;
                            Utils.toast("Error de conexi√≥n. Modo Offline.", "error");
                            resolve();
                        }
                    });
                });
            },

            /**
             * ALGORITMO DE SELECCI√ìN INTELIGENTE (FALLBACK LOGIC)
             * 1. Prioridad: Intereses del usuario && No visto.
             * 2. Fallback 1: Cualquier categor√≠a && No visto (Descubrimiento).
             * 3. Fallback 2: Intereses del usuario (Aunque ya visto - Repaso).
             * 4. Fallback 3: Cualquier cosa (Loop infinito).
             */
            getNextBlock() {
                const interests = Store.data.interests;
                const viewed = Store.data.viewed;

                // Nivel 1: Intereses + Nuevo
                let pool = this.db.filter(item => interests.includes(item.Categoria) && !viewed.includes(item.Titulo));

                // Nivel 2: Descubrimiento (Algo nuevo de otras categor√≠as)
                if (pool.length === 0) {
                    pool = this.db.filter(item => !viewed.includes(item.Titulo));
                }

                // Nivel 3: Repaso (Reset parcial impl√≠cito)
                if (pool.length === 0) {
                    pool = this.db.filter(item => interests.includes(item.Categoria));
                }

                // Nivel 4: Loop Total
                if (pool.length === 0) {
                    pool = this.db;
                }

                // Selecci√≥n aleatoria del pool resultante
                const selected = pool[Math.floor(Math.random() * pool.length)];
                return selected;
            }
        };

        /**
         * M√ìDULO 5: RENDERIZADO DE UI
         * Manipulaci√≥n del DOM.
         */
        const UI = {
            container: document.getElementById('feed-engine'),
            observer: null,

            // Crea la tarjeta HTML
            createCard(data) {
                const el = document.createElement('article');
                el.className = 'brick-card bg-bg border-b border-border/20';
                
                // Generar URL de Imagen (Pollinations AI)
                const keyword = data.ImagenKeyword || "Abstract geometric dark";
                const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(keyword)}%20dark%20moody%20minimalist%20industrial%20wallpaper?width=720&height=1280&nologo=true&seed=${Math.random()}`;

                const isLiked = Store.data.likes.includes(data.Titulo);

                el.innerHTML = `
                    <div class="absolute inset-0 z-0 bg-surface">
                        <img src="${imgUrl}" 
                             loading="lazy"
                             class="w-full h-full object-cover opacity-50 blur-[2px] scale-105 transition-transform duration-[10s] hover:scale-110 ease-linear" 
                             onload="this.style.opacity='0.4'">
                        <div class="absolute inset-0 bg-gradient-to-t from-bg via-bg/90 to-transparent"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-bg/60 to-transparent"></div>
                        
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/diagmonds-light.png')] opacity-10 mix-blend-overlay"></div>
                    </div>

                    <div class="relative z-10 flex flex-col h-full w-full p-6 pt-24 pb-[calc(var(--safe-bottom)+2rem)]">
                        
                        <div class="flex items-center justify-between mb-auto opacity-0 animate-slide-up" style="animation-delay: 100ms">
                            <div class="flex items-center gap-3">
                                <span class="bg-brick text-white text-[10px] font-mono font-bold uppercase px-2 py-1 tracking-widest shadow-[0_0_15px_rgba(230,57,70,0.4)]">
                                    ${data.Categoria}
                                </span>
                                <div class="h-px w-8 bg-white/20"></div>
                            </div>
                        </div>

                        <div class="flex flex-col justify-center my-8 opacity-0 animate-slide-up" style="animation-delay: 200ms">
                            <h2 class="text-3xl md:text-5xl font-black leading-[0.95] mb-6 text-white text-glow uppercase tracking-tight">
                                ${data.Titulo}
                            </h2>
                            
                            <div class="border-l-2 border-brick pl-5 py-1 backdrop-blur-sm bg-black/10">
                                <p class="text-lg md:text-xl text-gray-200 font-sans font-light leading-relaxed">
                                    ${data.Resumen}
                                </p>
                            </div>
                        </div>

                        <div class="mt-auto border-t border-white/10 pt-6 flex items-end justify-between opacity-0 animate-slide-up" style="animation-delay: 300ms">
                            
                            <div class="flex flex-col gap-1 max-w-[60%]">
                                <span class="text-[9px] font-mono text-txtMuted uppercase tracking-widest">Fuente Verificada</span>
                                <span class="text-xs font-bold text-white truncate">${data.Fuente}</span>
                            </div>

                            <div class="flex gap-3">
                                <a href="${data.Link}" target="_blank" class="w-12 h-12 flex items-center justify-center border border-white/10 bg-white/5 hover:bg-white/10 text-white transition active:scale-95 group">
                                    <i data-lucide="external-link" class="w-5 h-5 group-hover:text-brick transition-colors"></i>
                                </a>
                                
                                <button onclick="App.toggleLike(this, '${data.Titulo}')" class="w-12 h-12 flex items-center justify-center border border-white/10 bg-white/5 hover:bg-white/10 transition active:scale-95 group">
                                    <i data-lucide="heart" class="w-5 h-5 transition-colors ${isLiked ? 'text-brick fill-brick' : 'text-txtMuted group-hover:text-white'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="absolute top-4 right-4 z-0">
                        <svg width="40" height="40" viewBox="0 0 40 40" class="opacity-20">
                            <path d="M0 0 H40 V40" fill="none" stroke="white" stroke-width="1"/>
                        </svg>
                    </div>
                `;

                this.container.appendChild(el);
                
                // Observador para scroll infinito
                this.observer.observe(el);
                lucide.createIcons();
            },

            setupInfiniteScroll() {
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const card = entry.target;
                            
                            // Marcar como visto (Analytics)
                            const title = card.querySelector('h2').innerText;
                            Store.markViewed(title);
                            Sidebar.updateUI();

                            // L√≥gica de carga: Si es el pen√∫ltimo elemento, cargar el siguiente
                            if (card.nextElementSibling === null) {
                                App.loadNextBlock();
                            }
                        }
                    });
                }, { threshold: 0.5 }); // 50% de visibilidad activa el evento
            }
        };

        /**
         * M√ìDULO 6: CONTROLADOR DEL MEN√ö (SIDEBAR)
         */
        const Sidebar = {
            panel: document.getElementById('sidebar-panel'),
            backdrop: document.getElementById('sidebar-backdrop'),
            
            toggle() {
                const isClosed = this.panel.classList.contains('translate-x-full');
                if (isClosed) {
                    this.panel.classList.remove('translate-x-full');
                    this.backdrop.classList.remove('hidden');
                    setTimeout(() => this.backdrop.classList.remove('opacity-0'), 10);
                    this.updateUI();
                } else {
                    this.panel.classList.add('translate-x-full');
                    this.backdrop.classList.add('opacity-0');
                    setTimeout(() => this.backdrop.classList.add('hidden'), 300);
                }
                Utils.vibrate();
            },

            updateUI() {
                // M√©tricas
                document.getElementById('stat-read').innerText = Store.data.viewed.length;
                document.getElementById('stat-saved').innerText = Store.data.likes.length;

                // Filtros
                const container = document.getElementById('list-active-filters');
                container.innerHTML = '';
                Store.data.interests.forEach(cat => {
                    const tag = document.createElement('span');
                    tag.className = 'px-2 py-1 bg-white/5 border border-white/10 text-[9px] font-mono text-txtMuted uppercase';
                    tag.innerText = cat;
                    container.appendChild(tag);
                });
            }
        };

        /**
         * M√ìDULO 7: CONTROLADOR PRINCIPAL (APP)
         */
        const App = {
            async init() {
                Store.init();
                
                // Verificar si es usuario recurrente
                if (Store.data.onboarding) {
                    document.getElementById('app-layer-onboarding').style.display = 'none';
                    await ContentEngine.load();
                    this.startFeed();
                } else {
                    this.initOnboarding();
                }
            },

            // --- L√≥gica de Onboarding ---
            initOnboarding() {
                // Categor√≠as disponibles (Hardcoded para selecci√≥n inicial)
                const topics = [
                    "Tecnolog√≠a", "Ciencia", "Historia", "Arte", 
                    "Filosof√≠a", "Psicolog√≠a", "Negocios", "Astronom√≠a", 
                    "Cine", "Literatura", "Pol√≠tica", "Biolog√≠a"
                ];
                
                const grid = document.getElementById('grid-interests');
                topics.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "text-left p-4 bg-white/5 border border-white/10 text-txtMuted font-bold hover:bg-white/10 hover:border-brick transition-all active:scale-95 h-24 flex items-end";
                    btn.innerHTML = `<span class="text-sm font-mono uppercase">${t}</span>`;
                    
                    btn.onclick = () => {
                        if (Store.data.interests.includes(t)) {
                            Store.data.interests = Store.data.interests.filter(i => i !== t);
                            btn.classList.remove('border-brick', 'bg-brick/10', 'text-white');
                            btn.classList.add('border-white/10', 'bg-white/5', 'text-txtMuted');
                        } else {
                            if (Store.data.interests.length >= 5) return; // Max 5
                            Store.data.interests.push(t);
                            btn.classList.add('border-brick', 'bg-brick/10', 'text-white');
                            btn.classList.remove('border-white/10', 'bg-white/5', 'text-txtMuted');
                        }
                        
                        document.getElementById('counter-interests').innerText = `${Store.data.interests.length}/3`;
                        document.getElementById('btn-start').disabled = Store.data.interests.length < 3;
                        Utils.vibrate(5);
                    };
                    grid.appendChild(btn);
                });
            },

            async completeOnboarding() {
                Store.data.onboarding = true;
                Store.save();
                
                // Animaci√≥n de salida
                const layer = document.getElementById('app-layer-onboarding');
                layer.style.transform = 'translateY(-100%)';
                
                await ContentEngine.load();
                
                setTimeout(() => {
                    layer.style.display = 'none';
                    this.startFeed();
                }, 600);
            },

            // --- L√≥gica del Feed ---
            startFeed() {
                document.getElementById('loader-initial').remove();
                document.getElementById('loader-infinite').style.opacity = '1';
                
                UI.setupInfiniteScroll();
                
                // Cargar buffer inicial (3 bloques)
                this.loadNextBlock();
                this.loadNextBlock();
                this.loadNextBlock();
            },

            loadNextBlock() {
                const data = ContentEngine.getNextBlock();
                if (data) {
                    UI.createCard(data);
                } else {
                    // Si falla catastr√≥ficamente
                    Utils.toast("No hay m√°s datos disponibles", "error");
                }
            },

            // --- Acciones de Usuario ---
            toggleLike(btn, id) {
                const isLiked = Store.toggleLike(id);
                const icon = btn.querySelector('svg');
                
                if (isLiked) {
                    icon.classList.add('text-brick', 'fill-brick');
                    icon.classList.remove('text-txtMuted');
                    Utils.toast("Bloque Guardado");
                    Utils.vibrate([10, 50, 10]);
                } else {
                    icon.classList.remove('text-brick', 'fill-brick');
                    icon.classList.add('text-txtMuted');
                    Utils.vibrate(10);
                }
            },

            refreshData() {
                if(confirm("¬øRecargar base de datos desde Sheets?")) {
                    location.reload();
                }
            },

            hardReset() {
                if(confirm("¬ø‚ö† FORMATEAR SISTEMA? Se borrar√°n todos tus progresos.")) {
                    Store.reset();
                }
            }
        };

        // INICIALIZACI√ìN
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
