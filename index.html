<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Bricked - Adaptive Knowledge OS">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BRICKED | Adaptive</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        /**
         * 丘멆잺 CONFIGURACI칍N DEL USUARIO 丘멆잺
         * Pega aqu칤 el enlace CSV publicado de tu Google Sheet.
         * Columnas requeridas: Categoria, Titulo, Resumen, Fuente, Link, ImagenKeyword
         */
        const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRH7tvjL9usAdbPX9T4hVaPjbk0eykei7sghqShiMzUMvUtpH80BEniasmAWBlgtjH4UjVy5dJBT-So/pub?output=csv"; 

        // Tailwind Config - Sistema de Dise침o
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // Paleta "Obsidian & Brick"
                        bg: '#050505',
                        surface: '#0A0A0A',
                        surfaceHighlight: '#141414',
                        border: 'rgba(255, 255, 255, 0.08)',
                        
                        // Acentos
                        primary: '#D62828',    // Rojo Intenso
                        accent: '#F77F00',     // Naranja Fuego
                        
                        // Textos
                        txtMain: '#F1F1F1',
                        txtMuted: '#888888',
                    },
                    height: {
                        'dvh': '100dvh', 
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(40px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Reset y Base */
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        body { 
            background-color: #050505; 
            color: #F1F1F1; 
            overflow: hidden; 
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
        }

        /* Scroll Engine Invisible */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #feed-engine {
            height: 100dvh;
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            position: relative;
            z-index: 10;
        }

        .brick-card {
            scroll-snap-align: start;
            scroll-snap-stop: always;
            height: 100dvh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #050505;
        }

        /* Texturas y Efectos */
        .bg-grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        .text-glow {
            text-shadow: 0 4px 20px rgba(0,0,0,0.8);
        }
        
        /* Glassmorphism Refinado */
        .glass-panel {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-left: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: -10px 0 40px rgba(0,0,0,0.8);
        }

        /* Toggles Personalizados */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #D62828;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #D62828;
        }
        
        /* Loader Animation */
        .loader-bar {
            width: 4px;
            height: 100%;
            background: #D62828;
            animation: loadY 1s ease-in-out infinite;
        }
        @keyframes loadY { 0%, 100% { height: 10%; } 50% { height: 100%; } }

    </style>
</head>
<body class="antialiased selection:bg-primary selection:text-white">

    <div class="bg-grain"></div>

    <div id="splash-screen" class="fixed inset-0 z-[100] bg-bg flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative flex gap-2 h-12 items-center mb-6">
            <div class="loader-bar" style="animation-delay: 0s"></div>
            <div class="loader-bar" style="animation-delay: 0.1s"></div>
            <div class="loader-bar" style="animation-delay: 0.2s"></div>
            <div class="loader-bar" style="animation-delay: 0.3s"></div>
        </div>
        <h1 class="text-4xl font-serif font-bold text-white tracking-tight mb-2">BRICKED</h1>
        <p class="text-xs font-mono text-primary uppercase tracking-[0.3em]">Adaptive Engine</p>
        <p id="loading-status" class="mt-8 text-[10px] font-mono text-txtMuted animate-pulse">Conectando base de datos...</p>
    </div>

    <nav class="fixed top-0 left-0 w-full z-40 px-5 pt-[var(--safe-top)] mt-4 flex justify-between items-start pointer-events-none mix-blend-difference">
        <div class="pointer-events-auto border border-white/10 bg-black/20 backdrop-blur px-3 py-1.5 flex items-center gap-3 rounded-sm">
            <div id="live-indicator" class="w-1.5 h-1.5 rounded-full bg-primary animate-pulse"></div>
            <span class="text-[10px] font-mono font-bold text-white tracking-widest">FEED</span>
        </div>

        <button onclick="Sidebar.toggle()" class="pointer-events-auto p-3 border border-white/10 bg-black/20 backdrop-blur text-white hover:bg-white/10 active:scale-95 transition-all group rounded-sm">
            <i data-lucide="sliders-horizontal" class="w-5 h-5 group-hover:rotate-180 transition-transform duration-500"></i>
        </button>
    </nav>

    <main id="feed-engine">
        </main>

    <div id="loader-infinite" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-30 opacity-0 transition-opacity pointer-events-none pb-[var(--safe-bottom)]">
        <div class="flex items-center gap-2 px-4 py-2 bg-black/80 backdrop-blur border border-white/10 rounded-full">
            <div class="w-3 h-3 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <span class="text-[10px] font-mono text-white uppercase">Cargando</span>
        </div>
    </div>

    <div id="toast-zone" class="fixed top-24 left-1/2 -translate-x-1/2 z-[60] flex flex-col gap-2 w-max max-w-[90vw] pointer-events-none"></div>

    <div id="sidebar-backdrop" onclick="Sidebar.toggle()" class="fixed inset-0 z-[45] bg-black/90 backdrop-blur-sm hidden opacity-0 transition-opacity duration-500"></div>
    
    <aside id="sidebar-panel" class="fixed inset-y-0 right-0 z-[50] w-80 glass-panel transform translate-x-full transition-transform duration-500 ease-out flex flex-col bg-[#0a0a0a]">
        
        <div class="pt-[var(--safe-top)] mt-4 px-6 pb-6 border-b border-border flex justify-between items-center bg-black/20">
            <div>
                <h2 class="font-serif font-bold text-xl text-white tracking-tight">Preferencias</h2>
                <p class="text-[10px] font-mono text-txtMuted mt-1">Personaliza tu algoritmo</p>
            </div>
            <button onclick="Sidebar.toggle()" class="text-txtMuted hover:text-white transition p-2 bg-white/5 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 no-scrollbar">
            
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-[10px] font-mono text-primary uppercase tracking-widest font-bold">Categor칤as Activas</h3>
                    <button onclick="App.resetFilters()" class="text-[10px] text-txtMuted underline hover:text-white">Mostrar Todo</button>
                </div>
                
                <div id="filter-list" class="space-y-3">
                    </div>
            </div>

            <div class="mb-8 pt-6 border-t border-border">
                <h3 class="text-[10px] font-mono text-txtMuted uppercase mb-4 tracking-widest">Tu Progreso</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-surfaceHighlight p-4 border border-border rounded-lg">
                        <span id="stat-read" class="block text-2xl font-serif font-bold text-white mb-1">0</span>
                        <span class="text-[9px] font-mono font-bold text-txtMuted uppercase">Vistos</span>
                    </div>
                    <div class="bg-surfaceHighlight p-4 border border-border rounded-lg">
                        <span id="stat-likes" class="block text-2xl font-serif font-bold text-primary mb-1">0</span>
                        <span class="text-[9px] font-mono font-bold text-txtMuted uppercase">Likes</span>
                    </div>
                </div>
            </div>

            <div class="mt-auto space-y-3">
                <button onclick="App.reloadDB()" class="w-full py-3 bg-surfaceHighlight border border-border text-white text-xs font-mono uppercase hover:bg-white/10 transition flex items-center justify-center gap-2 rounded-sm">
                    <i data-lucide="refresh-cw" class="w-3 h-3"></i> Sincronizar
                </button>
                
                <button onclick="App.hardReset()" class="w-full py-3 border border-red-900/40 text-red-500 text-xs font-mono uppercase hover:bg-red-900/10 transition flex items-center justify-center gap-2 rounded-sm">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Reset F치brica
                </button>
            </div>
        </div>
    </aside>

    <script>
        
        /**
         * M칍DULO 1: MOCK DATA (Fallback)
         * Datos de respaldo de alta calidad para cuando no hay Sheet.
         */
        const MOCK_DB = [
            { Categoria: "Tecnolog칤a", Titulo: "La Singularidad Tecnol칩gica", Resumen: "Un punto hipot칠tico en el futuro donde el crecimiento tecnol칩gico se vuelve incontrolable e irreversible, resultando en cambios insondables para la civilizaci칩n humana.", Fuente: "Kurzweil AI", Link: "#", ImagenKeyword: "Artificial Intelligence Abstract" },
            { Categoria: "F칤sica", Titulo: "Materia Oscura", Resumen: "Aproximadamente el 85% de la materia del universo es 'oscura', lo que significa que no interact칰a con el campo electromagn칠tico. No la vemos, pero su gravedad mantiene unidas a las galaxias.", Fuente: "CERN", Link: "#", ImagenKeyword: "Dark Matter Space" },
            { Categoria: "Arte", Titulo: "Wabi-Sabi", Resumen: "Una est칠tica japonesa centrada en la aceptaci칩n de la fugacidad y la imperfecci칩n. A veces se describe como belleza que es 'imperfecta, impermanente e incompleta'.", Fuente: "Kyoto Journal", Link: "#", ImagenKeyword: "Japanese Pottery Texture" },
            { Categoria: "Psicolog칤a", Titulo: "Efecto Stroop", Resumen: "Demuestra la interferencia en el tiempo de reacci칩n de una tarea. Cuando el nombre de un color (ej. 'Azul') est치 escrito en tinta roja, tardamos m치s en nombrar el color de la tinta.", Fuente: "Neuroscience News", Link: "#", ImagenKeyword: "Optical Illusion" },
            { Categoria: "Filosof칤a", Titulo: "Alegor칤a de la Caverna", Resumen: "Plat칩n describe a prisioneros que solo ven sombras en una pared y creen que son la realidad. Al salir, descubren que la verdad es mucho m치s compleja y brillante.", Fuente: "Stanford Encyclopedia", Link: "#", ImagenKeyword: "Cave Light Philosophy" },
            { Categoria: "Historia", Titulo: "Mecanismo de Anticitera", Resumen: "Una computadora anal칩gica antigua dise침ada para predecir posiciones astron칩micas y eclipses. Fue construida por los griegos alrededor del 150 a.C., mil a침os antes de algo similar.", Fuente: "Nature", Link: "#", ImagenKeyword: "Ancient Gear Mechanism" },
            { Categoria: "Biolog칤a", Titulo: "CRISPR-Cas9", Resumen: "Una tecnolog칤a revolucionaria que permite a los genetistas y m칠dicos editar partes del genoma eliminando, agregando o alterando secciones de la secuencia de ADN.", Fuente: "Science Mag", Link: "#", ImagenKeyword: "DNA Helix" }
        ];

        /**
         * M칍DULO 2: STORE & STATE
         * Gesti칩n de persistencia y l칩gica de usuario.
         */
        const AppStore = {
            key: 'bricked_adaptive_v2',
            state: {
                viewedIDs: [], // Lista de T칤tulos vistos
                likedIDs: [],  // Lista de T칤tulos likeados
                likedCategories: {}, // Mapa de frecuencia: { "F칤sica": 5, "Arte": 2 }
                activeFilters: [], // Categor칤as activas (Vac칤o = Todas)
            },

            init() {
                const saved = localStorage.getItem(this.key);
                if (saved) this.state = JSON.parse(saved);
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify(this.state));
            },

            markViewed(id) {
                if (!this.state.viewedIDs.includes(id)) {
                    this.state.viewedIDs.push(id);
                    // Mantener historial limpio (Max 500)
                    if (this.state.viewedIDs.length > 500) this.state.viewedIDs.shift();
                    this.save();
                }
            },

            toggleLike(item) {
                const id = item.Titulo;
                const cat = item.Categoria;
                let isLiked = false;

                if (this.state.likedIDs.includes(id)) {
                    // Remove Like
                    this.state.likedIDs = this.state.likedIDs.filter(x => x !== id);
                    if (this.state.likedCategories[cat]) this.state.likedCategories[cat]--;
                    isLiked = false;
                } else {
                    // Add Like
                    this.state.likedIDs.push(id);
                    this.state.likedCategories[cat] = (this.state.likedCategories[cat] || 0) + 1;
                    isLiked = true;
                }
                this.save();
                return isLiked;
            },

            toggleFilter(cat) {
                if (this.state.activeFilters.includes(cat)) {
                    this.state.activeFilters = this.state.activeFilters.filter(c => c !== cat);
                } else {
                    this.state.activeFilters.push(cat);
                }
                this.save();
                return this.state.activeFilters.includes(cat);
            },
            
            resetFilters() {
                this.state.activeFilters = [];
                this.save();
            }
        };

        /**
         * M칍DULO 3: CONTENT ENGINE
         * Algoritmo de recomendaci칩n y carga.
         */
        const ContentSystem = {
            db: [],
            categories: new Set(),

            async load() {
                return new Promise(resolve => {
                    if (!GOOGLE_SHEET_CSV_URL || GOOGLE_SHEET_CSV_URL.length < 5) {
                        this.useMock();
                        resolve();
                        return;
                    }

                    Papa.parse(GOOGLE_SHEET_CSV_URL, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (results) => {
                            const validData = results.data.filter(r => r.Titulo && r.Categoria);
                            if (validData.length > 0) {
                                this.db = validData;
                                this.extractCategories();
                                resolve();
                            } else {
                                this.useMock();
                                resolve();
                            }
                        },
                        error: () => {
                            this.useMock();
                            resolve();
                        }
                    });
                });
            },

            useMock() {
                console.warn("Usando Mock Data");
                this.db = MOCK_DB;
                this.extractCategories();
            },

            extractCategories() {
                this.db.forEach(item => this.categories.add(item.Categoria));
            },

            /**
             * 游 ALGORITMO ADAPTATIVO
             * Decide qu칠 tarjeta mostrar a continuaci칩n.
             */
            getRecommendation() {
                const { viewedIDs, activeFilters, likedCategories } = AppStore.state;
                
                // 1. Filtrar Universo (Filtros Activos)
                let candidates = this.db;
                if (activeFilters.length > 0) {
                    candidates = candidates.filter(item => activeFilters.includes(item.Categoria));
                }

                // 2. Separar Vistos de No Vistos
                const unviewed = candidates.filter(item => !viewedIDs.includes(item.Titulo));
                
                // Pool final a usar (si no hay nuevos, reusamos vistos - Loop)
                const pool = unviewed.length > 0 ? unviewed : candidates;

                if (pool.length === 0) return null;

                // 3. Sistema de Puntuaci칩n (Scoring)
                // Asignamos un puntaje a cada candidato basado en los Likes previos
                const scoredCandidates = pool.map(item => {
                    let score = Math.random() * 10; // Factor aleatorio (Serendipia)
                    
                    // Boost por Categor칤a Likeada
                    const catLikes = likedCategories[item.Categoria] || 0;
                    score += (catLikes * 5); // +5 puntos por cada like en esa categor칤a

                    return { item, score };
                });

                // 4. Ordenar y Seleccionar Ganador
                scoredCandidates.sort((a, b) => b.score - a.score);
                
                // Tomamos el top 1
                return scoredCandidates[0].item;
            }
        };

        /**
         * M칍DULO 4: UI SYSTEM
         * Renderizado y Control Visual.
         */
        const UISystem = {
            container: document.getElementById('feed-engine'),
            sidebarList: document.getElementById('filter-list'),
            observer: null,

            // Generador de Tarjetas
            renderCard(data) {
                const el = document.createElement('article');
                el.className = 'brick-card bg-bg border-b border-border/10';
                
                // Generar Imagen IA (Pollinations)
                const keyword = data.ImagenKeyword || "Abstract minimalism dark";
                const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(keyword)}%20cinematic%20lighting%20dark%20moody%204k%20wallpaper?width=720&height=1280&nologo=true&seed=${Math.random()}`;
                
                const isLiked = AppStore.state.likedIDs.includes(data.Titulo);

                el.innerHTML = `
                    <div class="absolute inset-0 z-0 bg-surface">
                        <img src="${imgUrl}" 
                             loading="lazy"
                             class="w-full h-full object-cover opacity-60 blur-[2px] scale-105 transition-transform duration-[20s] ease-linear hover:scale-110" 
                             onload="this.style.opacity='0.5'">
                        <div class="absolute inset-0 bg-gradient-to-t from-bg via-bg/80 to-transparent"></div>
                        <div class="absolute inset-0 bg-gradient-to-b from-bg/60 to-transparent"></div>
                        <div class="absolute inset-0 bg-black/20 mix-blend-overlay"></div>
                    </div>

                    <div class="relative z-10 flex flex-col h-full w-full p-6 pt-24 pb-[calc(var(--safe-bottom)+2rem)]">
                        
                        <div class="flex items-center justify-between opacity-0 animate-slide-up" style="animation-delay: 100ms">
                            <span class="bg-primary/90 text-white text-[10px] font-mono font-bold uppercase px-3 py-1 tracking-widest rounded-sm shadow-lg shadow-primary/20">
                                ${data.Categoria}
                            </span>
                        </div>

                        <div class="flex flex-col justify-center my-auto opacity-0 animate-slide-up" style="animation-delay: 200ms">
                            <h2 class="text-4xl md:text-5xl font-serif font-bold leading-[1.1] mb-6 text-white text-glow tracking-tight">
                                ${data.Titulo}
                            </h2>
                            
                            <div class="border-l-2 border-primary pl-6 py-2 backdrop-blur-sm bg-black/20 rounded-r-lg">
                                <p class="text-lg md:text-xl text-txtMain font-sans font-light leading-relaxed">
                                    ${data.Resumen}
                                </p>
                            </div>
                        </div>

                        <div class="mt-auto pt-8 flex items-end justify-between border-t border-white/10 opacity-0 animate-slide-up" style="animation-delay: 300ms">
                            <div class="flex flex-col gap-1 max-w-[60%]">
                                <span class="text-[9px] font-mono text-txtMuted uppercase tracking-widest">Fuente</span>
                                <span class="text-xs font-serif font-bold text-white italic truncate">${data.Fuente}</span>
                            </div>

                            <div class="flex gap-4">
                                <a href="${data.Link}" target="_blank" class="w-12 h-12 flex items-center justify-center bg-white/5 border border-white/10 rounded-full hover:bg-white/20 hover:border-white/30 transition active:scale-95">
                                    <i data-lucide="arrow-up-right" class="w-5 h-5 text-white"></i>
                                </a>
                                
                                <button onclick="App.handleLike(this, '${data.Titulo}', '${data.Categoria}')" class="w-12 h-12 flex items-center justify-center bg-white/5 border border-white/10 rounded-full hover:bg-white/20 transition active:scale-95 group">
                                    <i data-lucide="heart" class="w-5 h-5 transition-colors duration-300 ${isLiked ? 'text-primary fill-primary' : 'text-txtMuted group-hover:text-white'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                this.container.appendChild(el);
                this.observer.observe(el);
                lucide.createIcons();
            },

            // Generador de Sidebar
            renderSidebar() {
                this.sidebarList.innerHTML = '';
                const cats = Array.from(ContentSystem.categories).sort();
                
                cats.forEach(cat => {
                    const isActive = AppStore.state.activeFilters.includes(cat);
                    
                    const item = document.createElement('label');
                    item.className = "flex items-center justify-between p-3 rounded-md bg-surface border border-white/5 cursor-pointer hover:bg-surfaceHighlight transition";
                    
                    item.innerHTML = `
                        <span class="text-xs font-mono font-bold ${isActive ? 'text-white' : 'text-txtMuted'} uppercase">${cat}</span>
                        <div class="relative inline-block w-10 h-5 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 border-surface appearance-none cursor-pointer transition-all duration-300" 
                                ${isActive ? 'checked' : ''} 
                                onclick="App.handleFilter('${cat}')"/>
                            <label class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-800 cursor-pointer border border-white/10"></label>
                        </div>
                    `;
                    this.sidebarList.appendChild(item);
                });

                // Actualizar Stats
                document.getElementById('stat-read').innerText = AppStore.state.viewedIDs.length;
                document.getElementById('stat-likes').innerText = AppStore.state.likedIDs.length;
            },

            setupScrollObserver() {
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const card = entry.target;
                            
                            // Registrar Vista
                            const title = card.querySelector('h2').innerText.trim();
                            AppStore.markViewed(title);
                            
                            // Carga Infinita (Trigger en el pen칰ltimo)
                            if (!card.nextElementSibling) {
                                App.loadNext();
                            }
                        }
                    });
                }, { threshold: 0.6 });
            },

            toast(msg) {
                const el = document.createElement('div');
                el.className = "px-4 py-2 bg-black/80 backdrop-blur border border-primary/50 text-white text-xs font-mono font-bold uppercase rounded-full shadow-2xl animate-fade-in flex items-center gap-2";
                el.innerHTML = `<div class="w-2 h-2 bg-primary rounded-full animate-pulse"></div> ${msg}`;
                
                document.getElementById('toast-zone').appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 500);
                }, 2000);
            }
        };

        /**
         * M칍DULO 5: APP CONTROLLER
         * Cerebro principal.
         */
        const Sidebar = {
            panel: document.getElementById('sidebar-panel'),
            backdrop: document.getElementById('sidebar-backdrop'),
            toggle() {
                const closed = this.panel.classList.contains('translate-x-full');
                if (closed) {
                    this.panel.classList.remove('translate-x-full');
                    this.backdrop.classList.remove('hidden');
                    setTimeout(() => this.backdrop.classList.remove('opacity-0'), 10);
                    UISystem.renderSidebar(); // Refrescar estado visual
                } else {
                    this.panel.classList.add('translate-x-full');
                    this.backdrop.classList.add('opacity-0');
                    setTimeout(() => this.backdrop.classList.add('hidden'), 500);
                }
            }
        };

        const App = {
            async init() {
                AppStore.init();
                
                // Cargar datos
                await ContentSystem.load();
                
                // Ocultar Splash Screen
                document.getElementById('loading-status').innerText = "Sistema listo";
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    splash.style.opacity = '0';
                    setTimeout(() => splash.style.display = 'none', 700);
                    
                    this.startFeed();
                }, 1000);
            },

            startFeed() {
                document.getElementById('feed-engine').innerHTML = '';
                UISystem.setupScrollObserver();
                document.getElementById('loader-infinite').style.opacity = '1';
                
                // Buffer inicial
                this.loadNext();
                this.loadNext();
                this.loadNext(); // Precargar 3 tarjetas
            },

            loadNext() {
                const data = ContentSystem.getRecommendation();
                if (data) {
                    UISystem.renderCard(data);
                } else {
                    UISystem.toast("No hay m치s contenido disponible");
                }
            },

            handleLike(btn, title, category) {
                // Reconstruir objeto m칤nimo necesario
                const item = { Titulo: title, Categoria: category };
                const isLiked = AppStore.toggleLike(item);
                
                const icon = btn.querySelector('svg');
                if (isLiked) {
                    icon.classList.add('text-primary', 'fill-primary');
                    icon.classList.remove('text-txtMuted');
                    UISystem.toast("Algoritmo ajustado: " + category);
                    if (navigator.vibrate) navigator.vibrate(50);
                } else {
                    icon.classList.remove('text-primary', 'fill-primary');
                    icon.classList.add('text-txtMuted');
                }
                UISystem.renderSidebar(); // Actualizar contadores
            },

            handleFilter(cat) {
                AppStore.toggleFilter(cat);
                UISystem.renderSidebar();
                
                // Si cambiamos filtros, limpiar feed y recargar para reflejar cambios inmediatamente
                // Opcional: Podr칤amos solo aplicar a las siguientes, pero reiniciar es m치s claro para el usuario
                document.getElementById('feed-engine').innerHTML = '';
                this.loadNext();
                this.loadNext();
            },

            resetFilters() {
                AppStore.resetFilters();
                UISystem.renderSidebar();
                document.getElementById('feed-engine').innerHTML = '';
                this.loadNext();
                this.loadNext();
                UISystem.toast("Filtros eliminados");
            },

            reloadDB() {
                location.reload();
            },

            hardReset() {
                if(confirm("쮼st치s seguro? Se borrar치 todo tu historial de aprendizaje.")) {
                    localStorage.removeItem(AppStore.key);
                    location.reload();
                }
            }
        };

        // INICIAR SISTEMA
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
