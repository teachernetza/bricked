<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Essence - Live</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['Georgia', 'Cambria', 'Times New Roman', 'serif'],
                        sans: ['Segoe UI', 'Roboto', 'Helvetica', 'sans-serif'],
                    },
                    colors: {
                        brand: '#3B82F6', // Azul brillante
                        darkBg: '#000000', 
                        darkCard: '#121212',
                        paper: '#F3F4F6'
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* SCROLL SNAP & UTILIDADES */
        body { background-color: black; color: white; overflow: hidden; }
        
        .scroll-container {
            height: 100vh;
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container::-webkit-scrollbar { display: none; }

        .card {
            scroll-snap-align: start;
            height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Glassmorphism Sidebar */
        .glass-sidebar {
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Degradado para textos largos */
        .text-fade {
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 80%, transparent 100%);
        }
        
        /* Imagen de fondo con overlay */
        .bg-image-overlay {
            position: absolute;
            inset: 0;
            z-index: 0;
            opacity: 0.3;
            background-size: cover;
            background-position: center;
            mask-image: linear-gradient(to bottom, black 0%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 0%, transparent 100%);
        }
    </style>
</head>
<body class="bg-darkBg text-gray-100 antialiased selection:bg-brand selection:text-white">

    <div id="onboarding" class="fixed inset-0 z-50 bg-black flex flex-col p-8 transition-transform duration-700">
        <div class="mt-10 mb-6">
            <h1 class="text-4xl font-serif font-bold text-white mb-2">Essence.</h1>
            <p class="text-gray-400">Diseña tu flujo de conocimiento.</p>
        </div>
        
        <p class="text-sm font-bold uppercase tracking-widest text-brand mb-4">Elige 3 intereses</p>
        
        <div class="flex-1 overflow-y-auto grid grid-cols-2 gap-3 content-start pb-20" id="topic-grid">
            </div>

        <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black via-black to-transparent">
            <button id="btn-start" onclick="startApp()" disabled 
                class="w-full py-4 rounded-full bg-white text-black font-bold text-lg disabled:opacity-30 disabled:cursor-not-allowed transition-all active:scale-95">
                Comenzar
            </button>
        </div>
    </div>

    <button onclick="toggleSidebar()" class="fixed top-5 right-5 z-40 p-3 rounded-full bg-white/10 backdrop-blur border border-white/10 hover:bg-white/20 transition-all">
        <i data-lucide="menu" class="w-6 h-6 text-white"></i>
    </button>

    <div id="feed" class="scroll-container">
        </div>

    <div id="loading-trigger" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-30 opacity-0 pointer-events-none">
        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-brand"></div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 z-50 bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"></div>
    
    <div id="sidebar" class="fixed inset-y-0 right-0 z-50 w-80 glass-sidebar transform translate-x-full transition-transform duration-300 p-6 flex flex-col">
        <div class="flex justify-between items-center mb-10">
            <h2 class="font-serif font-bold text-xl">Tu Biblioteca</h2>
            <button onclick="toggleSidebar()"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                <div class="text-2xl font-bold text-brand" id="stat-reads">0</div>
                <div class="text-xs text-gray-400 uppercase">Leídos</div>
            </div>
            <div class="bg-white/5 p-4 rounded-xl border border-white/5">
                <div class="text-2xl font-bold text-pink-500" id="stat-likes">0</div>
                <div class="text-xs text-gray-400 uppercase">Likes</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto">
            <h3 class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-widest">Tus Intereses Activos</h3>
            <div id="active-topics-list" class="space-y-2">
                </div>
            
            <button onclick="resetApp()" class="mt-8 text-xs text-red-400 underline w-full text-left">Reiniciar todo</button>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN ---
        const TOPICS_POOL = [
            "Astronomía", "Psicología", "Filosofía", "Historia", "Biología", 
            "Física", "Arte", "Literatura", "Economía", "Sociología", 
            "Tecnología", "Cine", "Música", "Arquitectura", "Geografía",
            "Matemáticas", "Medicina", "Política", "Antropología", "Química"
        ];

        // --- ESTADO ---
        let state = {
            interests: [],
            history: [], // IDs de artículos ya vistos para no repetir
            likes: [],
            page: 1,
            isLoading: false
        };

        // --- MOTORES DE API (API ENGINES) ---

        // 1. Motor Wikipedia
        async function fetchWikipediaContent(topic) {
            try {
                // Paso 1: Buscar páginas relacionadas con el tema
                const searchUrl = `https://es.wikipedia.org/w/api.php?action=query&list=search&srsearch=${topic}&format=json&origin=*&srlimit=10`;
                const searchRes = await fetch(searchUrl).then(r => r.json());
                
                if (!searchRes.query || !searchRes.query.search.length) return null;

                // Filtrar resultados ya vistos
                const candidates = searchRes.query.search.filter(item => !state.history.includes(item.pageid));
                if (candidates.length === 0) return null;

                // Elegir uno al azar
                const chosen = candidates[Math.floor(Math.random() * candidates.length)];
                
                // Paso 2: Obtener detalles (Extracto e Imagen)
                const detailUrl = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(chosen.title)}`;
                const detail = await fetch(detailUrl).then(r => r.json());

                if (!detail.extract) return null;

                return {
                    id: detail.pageid,
                    type: 'Wiki',
                    source: 'Wikipedia',
                    category: topic,
                    title: detail.title,
                    text: detail.extract,
                    image: detail.thumbnail ? detail.thumbnail.source : null,
                    url: detail.content_urls ? detail.content_urls.desktop.page : `https://es.wikipedia.org/wiki/${chosen.title}`
                };

            } catch (e) {
                console.error("Wiki Error", e);
                return null;
            }
        }

        // 2. Motor Open Library (Libros)
        async function fetchBookContent(topic) {
            try {
                // Buscar libros en español sobre el tema
                const url = `https://openlibrary.org/search.json?q=${topic}&language=spa&limit=20&fields=title,author_name,key,first_sentence,cover_i`;
                const res = await fetch(url).then(r => r.json());

                if (!res.docs || res.docs.length === 0) return null;

                // Filtrar libros ya vistos (usando key)
                const candidates = res.docs.filter(book => !state.history.includes(book.key));
                const book = candidates[Math.floor(Math.random() * candidates.length)];

                if (!book) return null;

                const text = book.first_sentence ? 
                    `"${book.first_sentence[0]}"` : 
                    `Una obra destacada de ${book.author_name ? book.author_name[0] : 'Autor desconocido'} sobre ${topic}.`;

                return {
                    id: book.key,
                    type: 'Libro',
                    source: 'Open Library',
                    category: topic,
                    title: book.title,
                    text: text,
                    image: book.cover_i ? `https://covers.openlibrary.org/b/id/${book.cover_i}-L.jpg` : null,
                    url: `https://openlibrary.org${book.key}`
                };
            } catch (e) { return null; }
        }

        // --- CORE LOGIC ---

        async function generateCard() {
            if (state.isLoading) return;
            state.isLoading = true;
            document.getElementById('loading-trigger').style.opacity = '1';

            // 1. Elegir tema al azar de los intereses del usuario
            const randomTopic = state.interests[Math.floor(Math.random() * state.interests.length)];
            
            // 2. Decidir fuente (70% Wiki, 30% Libros)
            let data = null;
            if (Math.random() > 0.3) {
                data = await fetchWikipediaContent(randomTopic);
            } else {
                data = await fetchBookContent(randomTopic);
                // Fallback a Wiki si no hay libro
                if (!data) data = await fetchWikipediaContent(randomTopic);
            }

            // 3. Renderizar si hay datos
            if (data) {
                state.history.push(data.id);
                renderCardHTML(data);
                updateStats(); // Contar como leído (simplificado)
            }

            state.isLoading = false;
            document.getElementById('loading-trigger').style.opacity = '0';
        }

        function renderCardHTML(data) {
            const container = document.getElementById('feed');
            const card = document.createElement('div');
            card.className = "card bg-darkCard text-white border-b border-white/5";
            
            // Imagen de fondo (si existe)
            const bgImage = data.image ? `<div class="bg-image-overlay" style="background-image: url('${data.image}')"></div>` : '';
            
            // Icono según tipo
            const iconType = data.type === 'Libro' ? 'book' : 'globe';

            card.innerHTML = `
                ${bgImage}
                <div class="relative z-10 flex flex-col h-full p-8 pt-20 pb-10">
                    
                    <div class="flex items-center gap-2 mb-6 opacity-70">
                        <span class="px-3 py-1 rounded-full border border-white/20 text-xs font-bold uppercase tracking-widest bg-black/40 backdrop-blur">
                            ${data.category}
                        </span>
                        <div class="flex items-center gap-1 text-xs">
                            <i data-lucide="${iconType}" class="w-3 h-3"></i>
                            ${data.source}
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col justify-center animate-fade-in">
                        <h2 class="text-3xl md:text-5xl font-serif font-bold leading-tight mb-8 text-shadow-sm">
                            ${data.title}
                        </h2>
                        <p class="text-lg md:text-xl leading-relaxed text-gray-200 font-sans opacity-90 text-fade max-h-[40vh] overflow-hidden">
                            ${data.text} ...
                        </p>
                    </div>

                    <div class="mt-auto pt-6 flex items-center justify-between border-t border-white/10">
                        <a href="${data.url}" target="_blank" class="flex items-center gap-2 text-brand font-bold hover:underline">
                            Saber más <i data-lucide="external-link" class="w-4 h-4"></i>
                        </a>
                        
                        <div class="flex gap-4">
                            <button onclick="toggleLike(this)" class="p-3 rounded-full bg-white/5 hover:bg-white/10 border border-white/10 transition-transform active:scale-90">
                                <i data-lucide="heart" class="w-6 h-6 text-gray-300"></i>
                            </button>
                            <button onclick="shareData('${data.title}', '${data.url}')" class="p-3 rounded-full bg-white/5 hover:bg-white/10 border border-white/10">
                                <i data-lucide="share-2" class="w-6 h-6 text-gray-300"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(card);
            lucide.createIcons();
            
            // Animación de entrada
            card.animate([
                { opacity: 0, transform: 'scale(0.95)' },
                { opacity: 1, transform: 'scale(1)' }
            ], { duration: 500, easing: 'ease-out' });
        }

        // --- SISTEMA DE UI ---

        function init() {
            // Cargar estado
            const saved = localStorage.getItem('essence_live_state');
            if (saved) {
                state = JSON.parse(saved);
                if (state.interests.length > 0) {
                    document.getElementById('onboarding').style.display = 'none';
                    // Cargar primeras 3 tarjetas
                    generateCard();
                    generateCard();
                    generateCard();
                } else {
                    renderOnboarding();
                }
            } else {
                renderOnboarding();
            }

            // Configurar Scroll Infinito
            const feed = document.getElementById('feed');
            feed.addEventListener('scroll', () => {
                if (feed.scrollTop + feed.clientHeight >= feed.scrollHeight - 200) {
                    generateCard();
                }
            });

            updateSidebarUI();
        }

        function renderOnboarding() {
            const grid = document.getElementById('topic-grid');
            TOPICS_POOL.forEach(topic => {
                const btn = document.createElement('button');
                btn.className = "p-4 rounded-xl border border-white/10 bg-white/5 text-left text-gray-300 hover:bg-white/10 hover:border-brand transition-all";
                btn.innerText = topic;
                btn.onclick = () => {
                    if (state.interests.includes(topic)) {
                        state.interests = state.interests.filter(t => t !== topic);
                        btn.classList.remove('bg-brand', 'text-white', 'border-brand');
                        btn.classList.add('bg-white/5', 'text-gray-300');
                    } else {
                        state.interests.push(topic);
                        btn.classList.remove('bg-white/5', 'text-gray-300');
                        btn.classList.add('bg-brand', 'text-white', 'border-brand');
                    }
                    
                    const startBtn = document.getElementById('btn-start');
                    startBtn.disabled = state.interests.length < 3;
                    startBtn.innerText = state.interests.length < 3 ? `Elige ${3 - state.interests.length} más` : "Comenzar";
                };
                grid.appendChild(btn);
            });
        }

        function startApp() {
            saveState();
            const ob = document.getElementById('onboarding');
            ob.style.transform = 'translateY(-100%)';
            setTimeout(() => {
                ob.style.display = 'none';
                generateCard();
                generateCard();
            }, 700);
            updateSidebarUI();
        }

        function toggleLike(btn) {
            const icon = btn.querySelector('svg');
            if (btn.classList.contains('bg-pink-500')) {
                btn.classList.remove('bg-pink-500', 'text-white', 'border-transparent');
                btn.classList.add('bg-white/5', 'text-gray-300');
                icon.setAttribute('fill', 'none');
                state.likes.pop(); // Simplificado
            } else {
                btn.classList.add('bg-pink-500', 'text-white', 'border-transparent');
                btn.classList.remove('bg-white/5', 'text-gray-300');
                icon.setAttribute('fill', 'currentColor');
                state.likes.push(Date.now());
            }
            updateStats();
            saveState();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('translate-x-full');
            
            if (isClosed) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
                sidebar.classList.remove('translate-x-full');
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        function updateSidebarUI() {
            const list = document.getElementById('active-topics-list');
            list.innerHTML = '';
            state.interests.forEach(topic => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 text-gray-300";
                div.innerHTML = `<div class="w-2 h-2 rounded-full bg-brand"></div> ${topic}`;
                list.appendChild(div);
            });
            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-likes').innerText = state.likes.length;
            document.getElementById('stat-reads').innerText = state.history.length;
        }

        function shareData(title, url) {
            if (navigator.share) {
                navigator.share({ title: 'Essence', text: `Aprendí sobre: ${title}`, url: url });
            } else {
                alert("Enlace copiado al portapapeles: " + url);
            }
        }

        function saveState() {
            localStorage.setItem('essence_live_state', JSON.stringify(state));
        }

        function resetApp() {
            if(confirm("¿Borrar todo?")) {
                localStorage.removeItem('essence_live_state');
                location.reload();
            }
        }

        // Arrancar
        window.onload = init;

    </script>
</body>
</html>
