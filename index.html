<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Essence - Scroll infinito de conocimiento">
    <meta name="theme-color" content="#000000">
    <title>Essence | Knowledge OS</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['"Libre Baskerville"', 'serif'],
                        sans: ['"Manrope"', 'sans-serif'],
                    },
                    colors: {
                        // Paleta "Dark Academia"
                        bg: '#050505',
                        surface: '#121212',
                        surfaceHigh: '#1E1E1E',
                        primary: '#3B82F6', // Azul eléctrico suave
                        accent: '#F43F5E', // Rosa coral para likes
                        textMain: '#EAEAEA',
                        textMuted: '#A3A3A3',
                        border: '#262626'
                    },
                    height: {
                        'screen-dvh': '100dvh', // Altura dinámica real en móviles
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.7s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Reset y Base */
        * { -webkit-tap-highlight-color: transparent; }
        html { height: 100%; overflow: hidden; }
        body { 
            height: 100%; 
            overflow: hidden; 
            background-color: #050505; 
            color: #EAEAEA;
            /* Prevención de rebote en iOS */
            overscroll-behavior-y: none;
        }

        /* Contenedor Maestro del Scroll (SNAP) */
        #feed-master {
            height: 100dvh; /* Dynamic Viewport Height: Clave para Safari iOS */
            width: 100vw;
            overflow-y: scroll;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
            scrollbar-width: none; /* Firefox */
        }
        #feed-master::-webkit-scrollbar { display: none; /* Chrome/Safari */ }

        /* Tarjeta Individual */
        .knowledge-card {
            scroll-snap-align: start;
            scroll-snap-stop: always;
            height: 100dvh;
            width: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Fondo base por si no carga imagen */
            background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%);
        }

        /* Glassmorphism Real */
        .glass {
            background: rgba(20, 20, 20, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Gradientes de Legibilidad de Texto */
        .text-overlay-gradient {
            background: linear-gradient(
                to top,
                rgba(0,0,0,1) 0%,
                rgba(0,0,0,0.8) 40%,
                rgba(0,0,0,0.4) 70%,
                rgba(0,0,0,0) 100%
            );
        }

        /* Utilidad para limitar líneas de texto */
        .clamp-text {
            display: -webkit-box;
            -webkit-line-clamp: 10; /* Máximo líneas antes de cortar */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        @media (max-height: 700px) {
            .clamp-text { -webkit-line-clamp: 6; }
        }

        /* Animación de carga (Skeleton) */
        .skeleton {
            background: linear-gradient(90deg, #1f1f1f 25%, #2a2a2a 50%, #1f1f1f 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Safe Areas para iPhone X+ */
        .safe-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }
        .safe-pt { padding-top: env(safe-area-inset-top, 20px); }
    </style>
</head>
<body class="antialiased">

    <div id="onboarding-screen" class="fixed inset-0 z-50 bg-bg flex flex-col transition-transform duration-700">
        <div class="safe-pt px-6 pt-10 pb-4 bg-gradient-to-b from-bg to-transparent z-10">
            <h1 class="text-4xl font-serif font-bold text-white tracking-tight mb-2">Essence.</h1>
            <p class="text-textMuted text-sm font-medium">Curaduría de conocimiento inteligente.</p>
        </div>

        <div class="flex-1 overflow-y-auto px-6 pb-32 no-scrollbar">
            <div class="flex justify-between items-center mb-6">
                <span class="text-xs font-bold text-primary uppercase tracking-widest">Elige 3 intereses</span>
                <span id="topic-counter" class="text-xs text-textMuted font-mono">0/3</span>
            </div>
            
            <div id="topics-grid" class="grid grid-cols-2 gap-3">
                </div>
        </div>

        <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-bg via-bg to-transparent safe-pb z-20">
            <button id="btn-start" onclick="App.completeOnboarding()" disabled 
                class="w-full h-14 rounded-2xl bg-white text-black font-bold text-lg disabled:opacity-30 disabled:cursor-not-allowed transform active:scale-95 transition-all shadow-[0_0_20px_rgba(255,255,255,0.1)] flex items-center justify-center gap-3">
                <span>Comenzar Experiencia</span>
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
            </button>
        </div>
    </div>

    <nav class="fixed top-0 left-0 w-full z-40 px-5 pt-4 safe-pt flex justify-between items-start pointer-events-none">
        <div class="pointer-events-auto glass px-4 py-2 rounded-full flex items-center gap-2 animate-fade-in">
            <div class="w-2 h-2 rounded-full bg-primary animate-pulse"></div>
            <span class="text-xs font-bold tracking-widest text-white/90">LIVE</span>
        </div>

        <button onclick="window.Sidebar.toggle()" class="pointer-events-auto p-3 rounded-full glass text-white hover:bg-white/10 active:scale-90 transition-all shadow-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
    </nav>

    <main id="feed-master">
        <div id="initial-loader" class="h-screen w-full flex flex-col items-center justify-center gap-4">
            <div class="w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
            <p class="text-xs text-textMuted uppercase tracking-widest animate-pulse">Calibrando fuentes...</p>
        </div>
    </main>

    <div id="infinite-loader" class="fixed bottom-8 left-1/2 -translate-x-1/2 z-30 opacity-0 transition-opacity pointer-events-none safe-pb">
        <div class="flex gap-2">
            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-2 h-2 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
    </div>

    <div id="toast-container" class="fixed top-24 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2 w-max max-w-[90vw] pointer-events-none">
        </div>

    <div id="sidebar-overlay" onclick="window.Sidebar.toggle()" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300"></div>
    
    <aside id="sidebar-panel" class="fixed inset-y-0 right-0 z-50 w-80 glass transform translate-x-full transition-transform duration-300 flex flex-col bg-[#0a0a0a]">
        <div class="safe-pt px-6 pt-6 pb-4 border-b border-border flex justify-between items-center">
            <h2 class="font-serif font-bold text-xl text-white">Biblioteca</h2>
            <button onclick="window.Sidebar.toggle()" class="p-2 -mr-2 text-textMuted hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto p-6 no-scrollbar">
            <div class="grid grid-cols-2 gap-3 mb-8">
                <div class="bg-surfaceHigh p-4 rounded-2xl border border-border text-center">
                    <span id="stat-views" class="block text-2xl font-bold text-white mb-1">0</span>
                    <span class="text-[10px] font-bold text-textMuted uppercase tracking-wider">Artículos</span>
                </div>
                <div class="bg-surfaceHigh p-4 rounded-2xl border border-border text-center">
                    <span id="stat-likes" class="block text-2xl font-bold text-accent mb-1">0</span>
                    <span class="text-[10px] font-bold text-textMuted uppercase tracking-wider">Guardados</span>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-xs font-bold text-textMuted uppercase mb-4 tracking-widest">Tus Filtros Activos</h3>
                <div id="active-topics-list" class="flex flex-wrap gap-2">
                    </div>
            </div>

            <div class="mt-auto">
                <button onclick="App.hardReset()" class="w-full py-3 rounded-xl border border-red-900/50 text-red-400 text-sm font-medium hover:bg-red-900/10 transition flex items-center justify-center gap-2">
                    <i data-lucide="trash" class="w-4 h-4"></i>
                    Reiniciar Aplicación
                </button>
                <p class="text-center text-[10px] text-zinc-700 mt-4">v3.0.0 • Essence Engine</p>
            </div>
        </div>
    </aside>

    <script>
        /**
         * MÓDULO 1: UTILIDADES (Helpers)
         */
        const Utils = {
            random: (arr) => arr[Math.floor(Math.random() * arr.length)],
            shuffle: (arr) => arr.sort(() => Math.random() - 0.5),
            wait: (ms) => new Promise(r => setTimeout(r, ms)),
            truncate: (str, n) => str.length > n ? str.substr(0, n-1) + "..." : str,
            
            // Web Share API Wrapper
            share: async (data) => {
                if (navigator.share) {
                    try { await navigator.share(data); return true; } 
                    catch (err) { return false; }
                } else {
                    // Fallback: Copiar al portapapeles
                    navigator.clipboard.writeText(data.url);
                    UI.toast("Enlace copiado al portapapeles");
                    return true;
                }
            },

            // TTS (Text to Speech)
            speak: (text, btnElement) => {
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    btnElement.classList.remove('text-primary', 'bg-primary/10');
                    return;
                }
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                
                utterance.onstart = () => btnElement.classList.add('text-primary', 'bg-primary/10');
                utterance.onend = () => btnElement.classList.remove('text-primary', 'bg-primary/10');
                
                window.speechSynthesis.speak(utterance);
            }
        };

        /**
         * MÓDULO 2: GESTOR DE ESTADO (Local Storage)
         */
        const Store = {
            key: 'essence_v3_db',
            state: {
                onboarding: false,
                interests: [],
                history: [], // IDs vistos
                likes: [],   // Objetos guardados
            },

            init() {
                const saved = localStorage.getItem(this.key);
                if (saved) this.state = JSON.parse(saved);
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify(this.state));
                Sidebar.updateUI(); // Actualizar sidebar al guardar
            },

            toggleLike(cardData) {
                const idx = this.state.likes.findIndex(l => l.id === cardData.id);
                if (idx > -1) {
                    this.state.likes.splice(idx, 1);
                    this.save();
                    return false;
                } else {
                    this.state.likes.push(cardData);
                    this.save();
                    return true;
                }
            },

            addHistory(id) {
                if (!this.state.history.includes(id)) {
                    this.state.history.push(id);
                    if (this.state.history.length > 200) this.state.history.shift(); // Limite
                    this.save();
                }
            }
        };

        /**
         * MÓDULO 3: MOTOR DE APIS (El cerebro)
         */
        const APIManager = {
            // Fuentes de datos configurables
            sources: {
                WIKI: 'https://es.wikipedia.org/w/api.php',
                ART: 'https://api.artic.edu/api/v1/artworks/search',
                BOOKS: 'https://openlibrary.org/search.json',
                GEO: 'https://restcountries.com/v3.1/all' // Cachear esto sería ideal
            },

            // Estrategia de búsqueda
            async fetchNext(topics) {
                const topic = Utils.random(topics);
                const strategy = Math.random();

                try {
                    // 15% Arte, 20% Libros, 15% Geo, 50% Wikipedia
                    if (strategy < 0.15) return await this.getArt(topic);
                    if (strategy < 0.35) return await this.getBook(topic);
                    if (strategy < 0.50) return await this.getGeo(); // Geo suele ser random
                    return await this.getWiki(topic);
                } catch (e) {
                    console.warn("API Error, fallback to Wiki", e);
                    return await this.getWiki(topic);
                }
            },

            // --- FETCHERS ESPECÍFICOS ---

            async getWiki(query) {
                const url = `${this.sources.WIKI}?action=query&format=json&list=search&srsearch=${query}&origin=*&srlimit=5`;
                const res = await fetch(url).then(r => r.json());
                if (!res.query?.search.length) throw new Error("No Wiki results");

                // Filtrar duplicados
                const available = res.query.search.filter(i => !Store.state.history.includes('wiki_'+i.pageid));
                const item = available.length ? Utils.random(available) : res.query.search[0];

                // Obtener detalles (Imagen + Extracto)
                const detailUrl = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(item.title)}`;
                const detail = await fetch(detailUrl).then(r => r.json());

                return {
                    id: 'wiki_' + item.pageid,
                    type: 'knowledge',
                    source: 'Wikipedia',
                    category: query,
                    title: detail.title,
                    text: detail.extract,
                    image: detail.thumbnail?.source || null,
                    url: detail.content_urls?.desktop?.page || '#'
                };
            },

            async getArt(query) {
                // El arte es visual, buscamos términos generales si el query es muy específico
                const q = ['Arte', 'Pintura', 'Retrato', 'Paisaje'].includes(query) ? query : 'Painting'; 
                const url = `${this.sources.ART}?q=${q}&limit=20&fields=id,title,artist_display,image_id,description`;
                const res = await fetch(url).then(r => r.json());
                
                const valid = res.data.filter(i => i.image_id && !Store.state.history.includes('art_'+i.id));
                if (!valid.length) throw new Error("No Art results");
                const item = Utils.random(valid);

                return {
                    id: 'art_' + item.id,
                    type: 'art',
                    source: 'Art Institute Chicago',
                    category: 'Arte Clásico',
                    title: item.title,
                    text: item.description ? item.description.replace(/<[^>]*>?/gm, '') : `Una obra maestra creada por ${item.artist_display}. Observa los detalles de la técnica y la composición.`,
                    image: `https://www.artic.edu/iiif/2/${item.image_id}/full/843,/0/default.jpg`,
                    url: `https://www.artic.edu/artworks/${item.id}`
                };
            },

            async getBook(query) {
                const url = `${this.sources.BOOKS}?q=${query}&language=spa&limit=10&fields=key,title,author_name,first_sentence,cover_i`;
                const res = await fetch(url).then(r => r.json());
                
                const valid = res.docs.filter(i => i.cover_i && !Store.state.history.includes(i.key));
                if (!valid.length) throw new Error("No Book results");
                const item = Utils.random(valid);

                const text = item.first_sentence 
                    ? (Array.isArray(item.first_sentence) ? item.first_sentence[0] : item.first_sentence)
                    : `Obra literaria destacada de ${item.author_name?.[0] || 'Autor desconocido'}. Un libro esencial para entender el tema ${query}.`;

                return {
                    id: item.key,
                    type: 'book',
                    source: 'Open Library',
                    category: 'Literatura',
                    title: item.title,
                    text: `"${text}"`,
                    image: `https://covers.openlibrary.org/b/id/${item.cover_i}-L.jpg`,
                    url: `https://openlibrary.org${item.key}`
                };
            },

            async getGeo() {
                // Cachear esto en memoria sería mejor, pero hacemos fetch
                const res = await fetch('https://restcountries.com/v3.1/region/americas').then(r => r.json());
                const item = Utils.random(res);
                
                return {
                    id: 'geo_' + item.cca3,
                    type: 'geo',
                    source: 'Datos Mundiales',
                    category: 'Geografía',
                    title: item.translations.spa.common,
                    text: `Capital: ${item.capital?.[0]}. Población: ${item.population.toLocaleString()}. Se encuentra en la subregión de ${item.subregion}. Su bandera tiene colores distintivos de su historia.`,
                    image: item.flags.svg, // Bandera como imagen
                    url: item.maps.googleMaps
                };
            }
        };

        /**
         * MÓDULO 4: RENDERIZADO DE UI (DOM Manipulation)
         */
        const UI = {
            container: document.getElementById('feed-master'),
            
            toast(msg) {
                const el = document.createElement('div');
                el.className = "bg-white/10 backdrop-blur text-white px-4 py-2 rounded-lg text-xs font-bold shadow-xl animate-fade-in border border-white/10";
                el.innerText = msg;
                document.getElementById('toast-container').appendChild(el);
                setTimeout(() => el.remove(), 3000);
            },

            createCard(data) {
                const el = document.createElement('article');
                el.className = 'knowledge-card';
                el.dataset.id = data.id;

                // Lógica de Imagen de Fondo
                let bgHTML = '';
                if (data.image) {
                    // Si es bandera (geo) o libro, usamos 'contain' o blur, si es arte 'cover'
                    const isArt = data.type === 'art';
                    const isGeo = data.type === 'geo';
                    
                    bgHTML = `
                        <div class="absolute inset-0 z-0 select-none">
                            <img src="${data.image}" 
                                 class="w-full h-full object-cover transition-transform duration-[20s] ease-linear scale-100" 
                                 onload="this.classList.add('scale-110')"
                                 style="${isGeo ? 'object-fit: cover; opacity: 0.4; filter: blur(10px);' : 'opacity: 0.6;'}"
                            />
                            <div class="absolute inset-0 bg-gradient-to-t from-bg via-bg/90 to-bg/30"></div>
                            <div class="absolute inset-0 bg-black/20"></div>
                        </div>
                    `;
                }

                el.innerHTML = `
                    ${bgHTML}
                    
                    <div class="relative z-10 flex flex-col h-full w-full max-w-lg mx-auto p-6 safe-pt safe-pb">
                        
                        <div class="mt-16 flex items-center justify-between opacity-0 animate-slide-up" style="animation-delay: 0.1s">
                            <span class="px-3 py-1 rounded-full border border-white/10 text-[10px] font-bold uppercase tracking-widest bg-black/40 backdrop-blur text-primary">
                                ${data.category}
                            </span>
                            <div class="flex items-center gap-2 text-[10px] text-textMuted font-medium uppercase tracking-wide bg-black/40 px-2 py-1 rounded-lg backdrop-blur">
                                <span>${data.source}</span>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col justify-center my-6 opacity-0 animate-slide-up" style="animation-delay: 0.2s">
                            <h2 class="text-3xl md:text-5xl font-serif font-bold leading-[1.1] mb-6 text-white text-shadow-lg">
                                ${data.title}
                            </h2>
                            
                            <div class="relative group">
                                <div class="w-12 h-1 bg-primary mb-6 rounded-full opacity-50"></div>
                                <p class="text-lg md:text-xl leading-relaxed text-textMain font-sans font-light opacity-90 clamp-text">
                                    ${data.text}
                                </p>
                            </div>
                        </div>

                        <div class="mt-auto pt-6 flex items-center justify-between border-t border-white/10 opacity-0 animate-slide-up" style="animation-delay: 0.3s">
                            
                            <a href="${data.url}" target="_blank" class="flex items-center gap-2 pr-6 py-3 rounded-l-full hover:opacity-80 transition-opacity">
                                <span class="text-sm font-bold text-white border-b border-primary pb-0.5">Profundizar</span>
                                <i data-lucide="arrow-up-right" class="w-4 h-4 text-primary"></i>
                            </a>

                            <div class="flex gap-3">
                                <button onclick="Utils.speak(this.dataset.text, this)" data-text="${data.text.replace(/"/g, '&quot;')}" class="p-3 rounded-full bg-white/5 border border-white/10 active:scale-95 transition hover:bg-white/10">
                                    <i data-lucide="volume-2" class="w-5 h-5 text-textMuted"></i>
                                </button>
                                
                                <button onclick="Utils.share({title: '${data.title}', text: '${data.title}', url: '${data.url}'})" class="p-3 rounded-full bg-white/5 border border-white/10 active:scale-95 transition hover:bg-white/10">
                                    <i data-lucide="share-2" class="w-5 h-5 text-textMuted"></i>
                                </button>

                                <button onclick="App.handleLike(this, '${data.id}')" class="p-3 rounded-full bg-white/5 border border-white/10 active:scale-95 transition hover:bg-white/10 group">
                                    <i data-lucide="heart" class="w-5 h-5 text-textMuted group-hover:text-accent transition-colors"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                this.container.appendChild(el);
                
                // Observador para Scroll Infinito y Analytics
                this.observer.observe(el);
                lucide.createIcons();
            },

            initObserver() {
                this.observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const card = entry.target;
                            Store.addHistory(card.dataset.id);
                            Sidebar.updateUI(); // Actualizar contador
                            
                            // Si es la penúltima carta, cargar más
                            if (card.nextElementSibling === null || card.nextElementSibling.nextElementSibling === null) {
                                App.loadMore();
                            }
                        }
                    });
                }, { threshold: 0.5 });
            }
        };

        /**
         * MÓDULO 5: CONTROLADOR DEL MENÚ (Sidebar)
         */
        window.Sidebar = {
            el: document.getElementById('sidebar-panel'),
            overlay: document.getElementById('sidebar-overlay'),
            
            toggle() {
                const isClosed = this.el.classList.contains('translate-x-full');
                if (isClosed) {
                    this.overlay.classList.remove('hidden');
                    // Pequeño delay para permitir transición de opacidad
                    requestAnimationFrame(() => {
                        this.overlay.classList.remove('opacity-0');
                        this.el.classList.remove('translate-x-full');
                    });
                    this.updateUI();
                } else {
                    this.el.classList.add('translate-x-full');
                    this.overlay.classList.add('opacity-0');
                    setTimeout(() => this.overlay.classList.add('hidden'), 300);
                }
            },

            updateUI() {
                document.getElementById('stat-views').innerText = Store.state.history.length;
                document.getElementById('stat-likes').innerText = Store.state.likes.length;
                
                const list = document.getElementById('active-topics-list');
                list.innerHTML = '';
                Store.state.interests.forEach(topic => {
                    const chip = document.createElement('span');
                    chip.className = "px-3 py-1 rounded bg-surface border border-border text-xs text-textMuted";
                    chip.innerText = topic;
                    list.appendChild(chip);
                });
            }
        };

        /**
         * MÓDULO 6: CORE APP (Orquestador)
         */
        const App = {
            tempCards: [], // Cache local de la sesión
            isLoading: false,

            init() {
                Store.init();
                
                if (!Store.state.onboarding) {
                    this.renderOnboarding();
                } else {
                    document.getElementById('onboarding-screen').style.display = 'none';
                    this.startFeed();
                }
                
                UI.initObserver();
            },

            // --- Lógica de Onboarding ---
            renderOnboarding() {
                const topics = [
                    "Psicología", "Astronomía", "Filosofía", "Historia", 
                    "Tecnología", "Biología", "Arte", "Literatura", 
                    "Cine", "Arquitectura", "Música", "Política",
                    "Economía", "Sociología", "Física", "Química"
                ];
                
                const grid = document.getElementById('topics-grid');
                topics.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "text-left p-4 rounded-xl border border-white/10 bg-white/5 text-textMuted font-medium transition-all active:scale-95";
                    btn.innerText = t;
                    btn.onclick = () => {
                        const idx = Store.state.interests.indexOf(t);
                        if (idx > -1) {
                            Store.state.interests.splice(idx, 1);
                            btn.classList.remove('border-primary', 'bg-primary/20', 'text-white');
                        } else {
                            if (Store.state.interests.length >= 3) return;
                            Store.state.interests.push(t);
                            btn.classList.add('border-primary', 'bg-primary/20', 'text-white');
                        }
                        
                        // Actualizar UI Onboarding
                        document.getElementById('topic-counter').innerText = `${Store.state.interests.length}/3`;
                        const startBtn = document.getElementById('btn-start');
                        startBtn.disabled = Store.state.interests.length < 3;
                        if (!startBtn.disabled) startBtn.classList.add('bg-white', 'text-black');
                    };
                    grid.appendChild(btn);
                });
            },

            completeOnboarding() {
                Store.state.onboarding = true;
                Store.save();
                const screen = document.getElementById('onboarding-screen');
                screen.style.transform = 'translateY(-100%)';
                setTimeout(() => {
                    screen.style.display = 'none';
                    this.startFeed();
                }, 700);
            },

            // --- Lógica de Feed ---
            async startFeed() {
                // Carga inicial agresiva (3 cards)
                await this.loadMore();
                document.getElementById('initial-loader').remove();
                await this.loadMore();
                await this.loadMore();
            },

            async loadMore() {
                if (this.isLoading) return;
                this.isLoading = true;
                document.getElementById('infinite-loader').style.opacity = '1';

                try {
                    const data = await APIManager.fetchNext(Store.state.interests);
                    if (data) {
                        this.tempCards.push(data);
                        UI.createCard(data);
                    }
                } catch (e) {
                    console.error(e);
                }

                this.isLoading = false;
                document.getElementById('infinite-loader').style.opacity = '0';
            },

            handleLike(btn, id) {
                const card = this.tempCards.find(c => c.id === id);
                if (!card) return;

                const isLiked = Store.toggleLike(card);
                const icon = btn.querySelector('svg');
                
                if (isLiked) {
                    btn.classList.add('text-accent', 'bg-accent/10', 'border-accent/50');
                    btn.classList.remove('text-textMuted');
                    icon.setAttribute('fill', 'currentColor');
                    UI.toast("Guardado en tu biblioteca");
                    if (navigator.vibrate) navigator.vibrate(50);
                } else {
                    btn.classList.remove('text-accent', 'bg-accent/10', 'border-accent/50');
                    btn.classList.add('text-textMuted');
                    icon.setAttribute('fill', 'none');
                }
            },

            hardReset() {
                if (confirm("¿Borrar todo y reiniciar?")) {
                    localStorage.removeItem(Store.key);
                    location.reload();
                }
            }
        };

        // ARRANCAR
        window.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
